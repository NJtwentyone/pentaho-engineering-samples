<!doctype html>
<html>

<head>
  <style>
    #viz_div {
      border: solid 1px #005da6;
      width: 95vw;
      height: 80vh;
    }
  </style>

  <!-- Load the Viz. API development context -->
  <script type="text/javascript" src="node_modules/@pentaho/viz-api/webcontext.js"></script>

  <script type="text/javascript">
    /* globals require */

    require.config({
      paths: {
        "d3": "./node_modules/d3/build/d3"
      }
    });

    require([
      "pentaho/visual/util",
      "pentaho/visual/action/Execute",
      "pentaho/visual/action/Select",
      "pentaho/data/Table",
      "json!./sandbox-data.json"
    ], function(visualUtil, ExecuteAction, SelectAction, Table, dataSpec) {

      var vizTypeId = "pentaho-visual-samples-bar-d3/Model";

      visualUtil.getModelAndDefaultViewClassesAsync(vizTypeId)
          .then(function(classes) {
            return createAndUpdateViz(classes.Model, classes.View, classes.viewTypeId);
          }, function(error) {
            alert(error.message);
          });

      function createAndUpdateViz(Model, View, viewTypeId) {

        // Get the DOM container.
        var domContainer = document.getElementById("viz_div");

        // Measure it.
        var rect = domContainer.getBoundingClientRect();

        var model = new Model({
          "width": rect.width,
          "height": rect.height,
          "data": new Table(dataSpec),
          "category": {fields: ["productFamily"]},
          "measure": {fields: ["sales"]}
        });

        // Handle the execute action.
        model.on(ExecuteAction.id, {
          "do": function(event, action) {
            showMessage("Executed " + action.dataFilter.$contentKey);
          }
        });

        // Handle the select action.
        model.on(SelectAction.id, {
          "finally": function(event, action) {
            showMessage("Selected: " + model.selectionFilter.$contentKey);
          }
        });

        // Mark the container with the model's CSS classes, for styling purposes.
        domContainer.className = visualUtil.getCssClasses(vizTypeId, viewTypeId);

        var view = new View({model: model, domContainer: domContainer});

        setupWindowResizeHandler(model, domContainer);
        setupWindowUnloadHandler(view);

        // Render the visualization.
        return model.update();
      }

      function setupWindowResizeHandler(model, domContainer) {
        window.onresize = function() {
          var rect = domContainer.getBoundingClientRect();

          model.configure({
            width: rect.width,
            height: rect.height
          });
        };
      }

      function setupWindowUnloadHandler(view) {

        window.onunload = function() {
          window.onunload = null;
          window.onresize = null;

          view.dispose();
        };
      }

      function showMessage(text) {
        document.getElementById("messages_div").innerText = text;
      }

    }, function(error) {
      alert(error.message);
    });
  </script>
</head>

<body>
  <div id="viz_div"></div>
  <div id="messages_div"></div>
</body>

</html>
